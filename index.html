<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡çœ è®°å½•</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header>
            <h1>ç¡çœ è®°å½•</h1>
            <div class="nav-buttons">
                <button onclick="window.location.href='history.html'" class="nav-btn">å†å²è®°å½•</button>
                <button onclick="window.location.href='analysis.html'" class="nav-btn">æ•°æ®åˆ†æ</button>
                <button id="githubLoginBtn" class="nav-btn">
                    <i class="fab fa-github"></i>
                    <span>è¿æ¥GitHub</span>
                </button>
                <span id="syncStatus" class="sync-status"></span>
            </div>
        </header>

        <!-- æ—¥å†é€‰æ‹©å™¨ -->
        <div class="calendar-container">
            <div class="date-picker">
                <input type="date" id="dateSelect">
            </div>
            <div class="week-days">
                <!-- æ—¥æœŸä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç¡çœ æ•ˆç‡å±•ç¤º -->
        <div class="sleep-efficiency">
            <div class="circle">
                <span id="efficiencyNumber">--</span>%
                <div class="label">ç¡çœ æ•ˆç‡</div>
            </div>
        </div>

        <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ -->
        <div class="data-cards">
            <div class="data-card">
                <i class="icon">â°</i>
                <div class="label">å®é™…ä½œæ¯</div>
                <div class="value" id="actualSleepTime">--:-- - --:--</div>
            </div>
            <div class="data-card">
                <i class="icon">âŒ›</i>
                <div class="label">ç¡çœ æ—¶é—´</div>
                <div class="value" id="sleepDuration">--h --m</div>
            </div>
            <div class="data-card">
                <i class="icon">ğŸŒ™</i>
                <div class="label">å…¥ç¡é€Ÿåº¦</div>
                <div class="value" id="fallAsleepSpeed">--åˆ†é’Ÿ</div>
            </div>
            <div class="data-card">
                <i class="icon"><i class="fas fa-bed"></i></i>
                <div class="label">åœ¨åºŠæ—¶é—´</div>
                <div class="value" id="effectiveSleep">--h --m</div>
            </div>
        </div>

        <!-- è®°å½•è¡¨å• -->
        <form id="sleepForm">
            <div class="form-group">
                <label for="bedTime">
                    <i class="fas fa-bed"></i> ä¸ŠåºŠæ—¶é—´
                </label>
                <input type="time" id="bedTime" required>
            </div>

            <div class="form-group">
                <label for="lightsOffTime">
                    <i class="fas fa-lightbulb"></i> å…³ç¯æ—¶é—´
                </label>
                <input type="time" id="lightsOffTime" required>
            </div>

            <div class="form-group">
                <label for="timeToSleep">
                    <i class="fas fa-moon"></i> å…¥ç¡æ—¶é•¿
                </label>
                <input type="number" id="timeToSleep" required min="0">
            </div>

            <div class="form-group">
                <label for="wakeCount">
                    <i class="fas fa-clock"></i> é†’æ¥æ¬¡æ•°
                </label>
                <input type="number" id="wakeCount" min="0" value="0">
            </div>

            <div id="wakeRecords">
                <!-- åŠ¨æ€æ·»åŠ é†’æ¥è®°å½• -->
            </div>

            <button type="button" id="addWakeRecord" class="secondary-btn">æ·»åŠ é†’æ¥è®°å½•</button>

            <div class="form-group">
                <label for="finalWakeTime">
                    <i class="fas fa-sun"></i> æœ€ç»ˆé†’æ¥æ—¶é—´
                </label>
                <input type="time" id="finalWakeTime" required>
            </div>

            <div class="form-group">
                <label for="getUpTime">
                    <i class="fas fa-walking"></i> èµ·åºŠæ—¶é—´
                </label>
                <input type="time" id="getUpTime" required>
            </div>

            <!-- è¯„åˆ†æ»‘å— -->
            <div class="ratings-container">
                <div class="form-group half-width">
                    <label for="sleepQuality">
                        <i class="fas fa-star"></i> ç¡çœ è´¨é‡
                    </label>
                    <div class="slider-container">
                        <input type="range" id="sleepQuality" min="1" max="5" value="3">
                        <div class="slider-labels">
                            <span>å¾ˆå·®</span>
                            <span>è¾ƒå·®</span>
                            <span>ä¸€èˆ¬</span>
                            <span>è¾ƒå¥½</span>
                            <span>å¾ˆå¥½</span>
                        </div>
                        <div class="quality-display">
                            <div id="sleepQualityIcon" class="quality-icon"></div>
                            <span id="sleepQualityValue">3åˆ†</span>
                        </div>
                    </div>
                </div>
                <div class="form-group half-width">
                    <label for="fatigueLevel">
                        <i class="fas fa-battery-three-quarters"></i> ç¡é†’åçš„ç²¾ç¥çŠ¶æ€
                    </label>
                    <div class="slider-container">
                        <input type="range" id="fatigueLevel" min="1" max="5" value="3">
                        <div class="slider-labels">
                            <span>éå¸¸ç–²æƒ«</span>
                            <span>è¾ƒä¸ºç–²æƒ«</span>
                            <span>ä¸€èˆ¬</span>
                            <span>è¾ƒä¸ºæ¸…é†’</span>
                            <span>ç²¾ç¥é¥±æ»¡</span>
                        </div>
                        <div class="quality-display">
                            <div id="fatigueLevelIcon" class="quality-icon"></div>
                            <span id="fatigueLevelValue">3åˆ†</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="sleepAid">
                    <i class="fas fa-pills"></i> å…¥ç¡è¾…åŠ©
                </label>
                <input type="text" id="sleepAid" placeholder="ä¾‹å¦‚ï¼šå†¥æƒ³ã€é˜…è¯»ã€éŸ³ä¹...">
            </div>

            <div class="dream-toggle">
                <label for="hadDream">
                    <i class="fas fa-cloud-moon"></i> æ¢¦å¢ƒè®°å½•
                    <input type="checkbox" id="hadDream">
                </label>
            </div>
            <div id="dreamContentContainer" style="display: none;">
                <div class="form-group">
                    <label for="dreamContent">
                        <i class="fas fa-edit"></i> è®°å½•æ¢¦å¢ƒå†…å®¹
                    </label>
                    <textarea id="dreamContent" placeholder="æè¿°ä½ çš„æ¢¦..."></textarea>
                </div>
            </div>

            <button type="submit" class="submit-btn">ä¿å­˜è®°å½•</button>
        </form>

        <!-- æ•°æ®åˆ†æéƒ¨åˆ† -->
        <div class="analysis-section" style="display: none;">
            <div class="charts-container">
                <div class="chart-card">
                    <h3>ç¡çœ è¶‹åŠ¿</h3>
                    <canvas id="sleepTrendChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ç¡çœ æ•ˆç‡åˆ†æ</h3>
                    <canvas id="sleepEfficiencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•éƒ¨åˆ† -->
        <div class="history-section" style="display: none;">
            <div class="history-filters">
                <select id="historyMonth"></select>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- å¯¼å‡ºæŒ‰é’® -->
        <div class="export-buttons">
            <button id="exportCSV" class="export-btn">å¯¼å‡ºCSV</button>
            <button id="exportJSON" class="export-btn">å¯¼å‡ºJSON</button>
        </div>

        <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" style="display: none;">
            <h3>è®¾ç½®</h3>
            <div class="settings-content">
                <div class="setting-item">
                    <button id="logoutBtn" class="secondary-btn">æ–­å¼€è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="github-sync.js"></script>
    <script src="script.js"></script>
    <script>
    document.getElementById('hadDream').addEventListener('change', function() {
        const container = document.getElementById('dreamContentContainer');
        container.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('dreamContent').value = '';
        }
    });

    function analyzeSleepPattern(data) {
        const analysis = {
            suggestions: [],
            patterns: []
        };

        // åˆ†æç¡çœ æ—¶é•¿
        const sleepDuration = calculateSleepDuration(data);
        if (sleepDuration < 420) { // 7å°æ—¶
            analysis.suggestions.push("ç¡çœ æ—¶é—´ä¸è¶³ï¼Œå»ºè®®ä¿è¯7-8å°æ—¶çš„ç¡çœ æ—¶é—´");
        }

        // åˆ†æå…¥ç¡æ—¶é—´
        if (data.timeToSleep > 30) {
            analysis.suggestions.push("å…¥ç¡æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®ï¼š\n- é¿å…ç¡å‰ä½¿ç”¨ç”µå­è®¾å¤‡\n- å°è¯•æ”¾æ¾æŠ€å·§å¦‚æ·±å‘¼å¸æˆ–å†¥æƒ³");
        }

        // åˆ†æç¡çœ æ•ˆç‡
        const metrics = calculateSleepMetrics(data);
        if (parseFloat(metrics.efficiency) < 85) {
            analysis.suggestions.push("ç¡çœ æ•ˆç‡åä½ï¼Œå»ºè®®ï¼š\n- å›ºå®šä½œæ¯æ—¶é—´\n- å‡å°‘åºŠä¸Šéç¡çœ æ´»åŠ¨");
        }

        return analysis;
    }

    function showHistory() {
        window.location.href = 'history.html';
    }

    function showAnalysis() {
        window.location.href = 'analysis.html';
    }

    // æ·»åŠ å¯¼å‡ºCSVåŠŸèƒ½
    function exportToCSV() {
        // è·å–æ‰€æœ‰ç¡çœ è®°å½•
        const sleepData = JSON.parse(localStorage.getItem('sleepRecords')) || [];
        
        if (sleepData.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç¡çœ è®°å½•');
            return;
        }
        
        // åˆ›å»ºCSVå†…å®¹
        let csvContent = "æ—¥æœŸ,ä¸ŠåºŠæ—¶é—´,å…³ç¯æ—¶é—´,å…¥ç¡æ—¶é•¿(åˆ†é’Ÿ),é†’æ¥æ¬¡æ•°,æœ€ç»ˆé†’æ¥æ—¶é—´,èµ·åºŠæ—¶é—´,ç¡çœ è´¨é‡,ç²¾ç¥çŠ¶æ€,å…¥ç¡è¾…åŠ©,æ¢¦å¢ƒè®°å½•\n";
        
        sleepData.forEach(record => {
            const row = [
                record.date,
                record.bedTime,
                record.lightsOffTime,
                record.timeToSleep,
                record.wakeCount,
                record.finalWakeTime,
                record.getUpTime,
                record.sleepQuality,
                record.fatigueLevel,
                record.sleepAid || '',
                record.dreamContent ? 'æœ‰' : 'æ— '
            ];
            
            // å¤„ç†CSVä¸­çš„ç‰¹æ®Šå­—ç¬¦
            const processedRow = row.map(item => {
                if (typeof item === 'string' && (item.includes(',') || item.includes('"') || item.includes('\n'))) {
                    return `"${item.replace(/"/g, '""')}"`;
                }
                return item;
            });
            
            csvContent += processedRow.join(',') + '\n';
        });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `ç¡çœ è®°å½•_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // æ·»åŠ å¯¼å‡ºJSONåŠŸèƒ½
    function exportToJSON() {
        const sleepData = JSON.parse(localStorage.getItem('sleepRecords')) || [];
        
        if (sleepData.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç¡çœ è®°å½•');
            return;
        }
        
        const jsonString = JSON.stringify(sleepData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `ç¡çœ è®°å½•_${new Date().toISOString().slice(0, 10)}.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // ... å…¶ä»–ä»£ç  ...
        
        // æ·»åŠ é†’æ¥è®°å½•æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('addWakeRecord').addEventListener('click', addWakeRecord);
        
        // æ·»åŠ å¯¼å‡ºæŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('exportCSV').addEventListener('click', exportToCSV);
        document.getElementById('exportJSON').addEventListener('click', exportToJSON);
    });
    </script>
</body>
</html>