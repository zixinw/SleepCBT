<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡çœ è®°å½•</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header>
            <h1>ç¡çœ è®°å½•</h1>
            <div class="nav-buttons">
                <button onclick="window.location.href='history.html'" class="nav-btn">å†å²è®°å½•</button>
                <button onclick="window.location.href='analysis.html'" class="nav-btn">æ•°æ®åˆ†æ</button>
                <button id="githubLoginBtn" class="nav-btn">
                    <i class="fab fa-github"></i>
                    <span>è¿æ¥GitHub</span>
                </button>
                <span id="syncStatus" class="sync-status"></span>
            </div>
        </header>

        <!-- æ—¥å†é€‰æ‹©å™¨ -->
        <div class="calendar-container">
            <div class="date-picker">
                <input type="date" id="dateSelect">
            </div>
            <div class="week-days">
                <!-- æ—¥æœŸä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç¡çœ æ•ˆç‡å±•ç¤º -->
        <div class="sleep-efficiency">
            <div class="circle">
                <span id="efficiencyNumber">--</span>%
                <div class="label">ç¡çœ æ•ˆç‡</div>
            </div>
        </div>

        <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ -->
        <div class="data-cards">
            <div class="data-card">
                <i class="icon">â°</i>
                <div class="label">å®é™…ä½œæ¯</div>
                <div class="value" id="actualSleepTime">--:-- - --:--</div>
            </div>
            <div class="data-card">
                <i class="icon">âŒ›</i>
                <div class="label">ç¡çœ æ—¶é—´</div>
                <div class="value" id="sleepDuration">--h --m</div>
            </div>
            <div class="data-card">
                <i class="icon">ğŸŒ™</i>
                <div class="label">å…¥ç¡é€Ÿåº¦</div>
                <div class="value" id="fallAsleepSpeed">--åˆ†é’Ÿ</div>
            </div>
            <div class="data-card">
                <i class="icon"><i class="fas fa-bed"></i></i>
                <div class="label">åœ¨åºŠæ—¶é—´</div>
                <div class="value" id="effectiveSleep">--h --m</div>
            </div>
        </div>

        <!-- è®°å½•è¡¨å• -->
        <form id="sleepForm">
            <div class="form-group">
                <label for="bedTime">
                    <i class="fas fa-bed"></i> ä¸ŠåºŠæ—¶é—´
                </label>
                <input type="time" id="bedTime" required>
            </div>

            <div class="form-group">
                <label for="lightsOffTime">
                    <i class="fas fa-lightbulb"></i> å…³ç¯æ—¶é—´
                </label>
                <input type="time" id="lightsOffTime" required>
            </div>

            <div class="form-group">
                <label for="timeToSleep">
                    <i class="fas fa-moon"></i> å…¥ç¡æ—¶é•¿
                </label>
                <input type="number" id="timeToSleep" required min="0">
            </div>

            <div class="form-group">
                <label for="wakeCount">
                    <i class="fas fa-clock"></i> é†’æ¥æ¬¡æ•°
                </label>
                <input type="number" id="wakeCount" min="0" value="0">
            </div>

            <div id="wakeRecords">
                <!-- åŠ¨æ€æ·»åŠ é†’æ¥è®°å½• -->
            </div>

            <button type="button" id="addWakeRecord" class="secondary-btn">æ·»åŠ é†’æ¥è®°å½•</button>

            <div class="form-group">
                <label for="finalWakeTime">
                    <i class="fas fa-sun"></i> æœ€ç»ˆé†’æ¥æ—¶é—´
                </label>
                <input type="time" id="finalWakeTime" required>
            </div>

            <div class="form-group">
                <label for="getUpTime">
                    <i class="fas fa-walking"></i> èµ·åºŠæ—¶é—´
                </label>
                <input type="time" id="getUpTime" required>
            </div>

            <!-- è¯„åˆ†æ»‘å— -->
            <div class="ratings-container">
                <div class="form-group half-width">
                    <label for="sleepQuality">
                        <i class="fas fa-star"></i> ç¡çœ è´¨é‡
                    </label>
                    <div class="slider-container">
                        <input type="range" id="sleepQuality" min="1" max="5" value="3">
                        <div class="slider-labels">
                            <span>å¾ˆå·®</span>
                            <span>è¾ƒå·®</span>
                            <span>ä¸€èˆ¬</span>
                            <span>è¾ƒå¥½</span>
                            <span>å¾ˆå¥½</span>
                        </div>
                        <div class="quality-display">
                            <div id="sleepQualityIcon" class="quality-icon"></div>
                            <span id="sleepQualityValue">3åˆ†</span>
                        </div>
                    </div>
                </div>
                <div class="form-group half-width">
                    <label for="fatigueLevel">
                        <i class="fas fa-battery-three-quarters"></i> ç¡é†’åçš„ç²¾ç¥çŠ¶æ€
                    </label>
                    <div class="slider-container">
                        <input type="range" id="fatigueLevel" min="1" max="5" value="3">
                        <div class="slider-labels">
                            <span>éå¸¸ç–²æƒ«</span>
                            <span>è¾ƒä¸ºç–²æƒ«</span>
                            <span>ä¸€èˆ¬</span>
                            <span>è¾ƒä¸ºæ¸…é†’</span>
                            <span>ç²¾ç¥é¥±æ»¡</span>
                        </div>
                        <div class="quality-display">
                            <div id="fatigueLevelIcon" class="quality-icon"></div>
                            <span id="fatigueLevelValue">3åˆ†</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="sleepAid">
                    <i class="fas fa-pills"></i> å…¥ç¡è¾…åŠ©
                </label>
                <input type="text" id="sleepAid" placeholder="ä¾‹å¦‚ï¼šå†¥æƒ³ã€é˜…è¯»ã€éŸ³ä¹...">
            </div>

            <div class="dream-toggle">
                <label for="hadDream">
                    <i class="fas fa-cloud-moon"></i> æ¢¦å¢ƒè®°å½•
                    <input type="checkbox" id="hadDream">
                </label>
            </div>
            <div id="dreamContentContainer" style="display: none;">
                <div class="form-group">
                    <label for="dreamContent">
                        <i class="fas fa-edit"></i> è®°å½•æ¢¦å¢ƒå†…å®¹
                    </label>
                    <textarea id="dreamContent" placeholder="æè¿°ä½ çš„æ¢¦..."></textarea>
                </div>
            </div>

            <button type="submit" class="submit-btn">ä¿å­˜è®°å½•</button>
        </form>

        <!-- æ•°æ®åˆ†æéƒ¨åˆ† -->
        <div class="analysis-section" style="display: none;">
            <div class="charts-container">
                <div class="chart-card">
                    <h3>ç¡çœ è¶‹åŠ¿</h3>
                    <canvas id="sleepTrendChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ç¡çœ æ•ˆç‡åˆ†æ</h3>
                    <canvas id="sleepEfficiencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•éƒ¨åˆ† -->
        <div class="history-section" style="display: none;">
            <div class="history-filters">
                <select id="historyMonth"></select>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- å¯¼å‡ºæŒ‰é’® -->
        <div class="export-buttons">
            <button id="exportCSV" class="export-btn">å¯¼å‡ºCSV</button>
            <button id="exportJSON" class="export-btn">å¯¼å‡ºJSON</button>
        </div>

        <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" style="display: none;">
            <h3>è®¾ç½®</h3>
            <div class="settings-content">
                <div class="setting-item">
                    <button id="logoutBtn" class="secondary-btn">æ–­å¼€è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="github-sync.js"></script>
    <script src="script.js"></script>
    <script>
    document.getElementById('hadDream').addEventListener('change', function() {
        const container = document.getElementById('dreamContentContainer');
        container.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('dreamContent').value = '';
        }
    });

    // ç¡®ä¿é¡µé¢åŠ è½½æ—¶æ£€æŸ¥GitHubç™»å½•çŠ¶æ€å¹¶åŠ è½½æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•GitHub
        const token = localStorage.getItem('github_token');
        if (token) {
            document.getElementById('githubLoginBtn').innerHTML = '<i class="fab fa-github"></i><span>å·²è¿æ¥</span>';
            document.getElementById('syncStatus').textContent = 'æ­£åœ¨åŒæ­¥...';
            
            // ä»GitHubåŠ è½½æ•°æ®
            loadDataFromGitHub(token)
                .then(() => {
                    document.getElementById('syncStatus').textContent = 'åŒæ­¥æˆåŠŸ';
                    // åŠ è½½å½“å‰æ—¥æœŸçš„æ•°æ®
                    loadCurrentDateData();
                })
                .catch(error => {
                    console.error('åŒæ­¥å¤±è´¥:', error);
                    document.getElementById('syncStatus').textContent = 'åŒæ­¥å¤±è´¥';
                });
        }
        
        // æ·»åŠ é†’æ¥è®°å½•æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('addWakeRecord').addEventListener('click', addWakeRecord);
        
        // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨ä¸ºä»Šå¤©
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        document.getElementById('dateSelect').value = dateString;
        
        // åˆå§‹åŒ–å‘¨è§†å›¾
        updateWeekView(today);
        
        // æ—¥æœŸé€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
        document.getElementById('dateSelect').addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            updateWeekView(selectedDate);
            loadSelectedDateData(selectedDate);
        });
    });

    // ä»GitHubåŠ è½½æ•°æ®çš„å‡½æ•°
    function loadDataFromGitHub(token) {
        return new Promise((resolve, reject) => {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨github-sync.jsä¸­çš„å‡½æ•°æ¥è·å–æ•°æ®
            // å‡è®¾github-sync.jsä¸­æœ‰ä¸€ä¸ªfetchDataFromGitHubå‡½æ•°
            if (typeof fetchDataFromGitHub === 'function') {
                fetchDataFromGitHub(token)
                    .then(data => {
                        // å°†æ•°æ®ä¿å­˜åˆ°localStorage
                        if (data && typeof data === 'object') {
                            Object.keys(data).forEach(date => {
                                localStorage.setItem(`sleep_data_${date}`, JSON.stringify(data[date]));
                            });
                        }
                        resolve();
                    })
                    .catch(reject);
            } else {
                // å¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦å®ç°å®ƒ
                console.warn('fetchDataFromGitHubå‡½æ•°æœªå®šä¹‰ï¼Œè¯·åœ¨github-sync.jsä¸­å®ç°');
                reject(new Error('åŒæ­¥å‡½æ•°æœªå®ç°'));
            }
        });
    }

    // åŠ è½½å½“å‰æ—¥æœŸçš„æ•°æ®
    function loadCurrentDateData() {
        const today = new Date();
        loadSelectedDateData(today);
    }

    // åŠ è½½é€‰å®šæ—¥æœŸçš„æ•°æ®
    function loadSelectedDateData(date) {
        const dateString = date.toISOString().split('T')[0];
        const dataKey = `sleep_data_${dateString}`;
        const savedData = localStorage.getItem(dataKey);
        
        if (savedData) {
            const data = JSON.parse(savedData);
            // å¡«å……è¡¨å•å’Œæ˜¾ç¤ºæ•°æ®
            fillFormWithData(data);
            updateSleepMetricsDisplay(data);
        } else {
            // æ¸…ç©ºè¡¨å•
            document.getElementById('sleepForm').reset();
            // é‡ç½®æ˜¾ç¤º
            document.getElementById('efficiencyNumber').textContent = '--';
            document.getElementById('actualSleepTime').textContent = '--:-- - --:--';
            document.getElementById('sleepDuration').textContent = '--h --m';
            document.getElementById('fallAsleepSpeed').textContent = '--åˆ†é’Ÿ';
            document.getElementById('effectiveSleep').textContent = '--h --m';
        }
    }

    // æ›´æ–°å‘¨è§†å›¾
    function updateWeekView(centerDate) {
        const weekDaysContainer = document.querySelector('.week-days');
        weekDaysContainer.innerHTML = '';
        
        // è·å–å½“å‰å‘¨çš„æ—¥æœŸ
        const currentDay = centerDate.getDay();
        const firstDay = new Date(centerDate);
        firstDay.setDate(centerDate.getDate() - currentDay);
        
        // è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼Œç”¨äºæ¯”è¾ƒ
        const selectedDateString = document.getElementById('dateSelect').value;
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(firstDay);
            date.setDate(firstDay.getDate() + i);
            
            const dateString = date.toISOString().split('T')[0];
            const dayElement = document.createElement('div');
            dayElement.className = 'day-item';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            const hasData = localStorage.getItem(`sleep_data_${dateString}`) !== null;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
            const isToday = date.toDateString() === new Date().toDateString();
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é€‰ä¸­æ—¥æœŸ - ä¿®æ”¹è¿™é‡Œï¼Œç›´æ¥æ¯”è¾ƒæ—¥æœŸå­—ç¬¦ä¸²
            const isSelected = dateString === selectedDateString;
            
            if (isToday) dayElement.classList.add('today');
            if (isSelected) dayElement.classList.add('selected');
            if (hasData) dayElement.classList.add('has-data');
            
            dayElement.innerHTML = `
                <div class="day-name">${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()]}</div>
                <div class="day-number">${date.getDate()}</div>
            `;
            
            dayElement.addEventListener('click', function() {
                // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨çš„å€¼
                document.getElementById('dateSelect').value = dateString;
                
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.day-item.selected').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
                
                // åŠ è½½é€‰å®šæ—¥æœŸçš„æ•°æ®
                loadSelectedDateData(date);
            });
            
            weekDaysContainer.appendChild(dayElement);
        }
    }

    // å¡«å……è¡¨å•æ•°æ®
    function fillFormWithData(data) {
        if (!data) return;
        
        // å¡«å……åŸºæœ¬å­—æ®µ
        if (data.bedTime) document.getElementById('bedTime').value = data.bedTime;
        if (data.lightsOffTime) document.getElementById('lightsOffTime').value = data.lightsOffTime;
        if (data.timeToSleep) document.getElementById('timeToSleep').value = data.timeToSleep;
        if (data.finalWakeTime) document.getElementById('finalWakeTime').value = data.finalWakeTime;
        if (data.getUpTime) document.getElementById('getUpTime').value = data.getUpTime;
        
        // å¡«å……è¯„åˆ†
        if (data.sleepQuality) {
            document.getElementById('sleepQuality').value = data.sleepQuality;
            document.getElementById('sleepQualityValue').textContent = `${data.sleepQuality}åˆ†`;
        }
        
        if (data.fatigueLevel) {
            document.getElementById('fatigueLevel').value = data.fatigueLevel;
            document.getElementById('fatigueLevelValue').textContent = `${data.fatigueLevel}åˆ†`;
        }
        
        // å¡«å……å…¶ä»–å­—æ®µ
        if (data.sleepAid) document.getElementById('sleepAid').value = data.sleepAid;
        
        // å¤„ç†æ¢¦å¢ƒè®°å½•
        if (data.hadDream) {
            document.getElementById('hadDream').checked = true;
            document.getElementById('dreamContentContainer').style.display = 'block';
            if (data.dreamContent) document.getElementById('dreamContent').value = data.dreamContent;
        } else {
            document.getElementById('hadDream').checked = false;
            document.getElementById('dreamContentContainer').style.display = 'none';
        }
        
        // å¤„ç†é†’æ¥è®°å½•
        if (data.wakeRecords && data.wakeRecords.length > 0) {
            document.getElementById('wakeCount').value = data.wakeRecords.length;
            
            // æ¸…ç©ºç°æœ‰è®°å½•
            document.getElementById('wakeRecords').innerHTML = '';
            
            // æ·»åŠ æ¯æ¡é†’æ¥è®°å½•
            data.wakeRecords.forEach((record, index) => {
                addWakeRecordToUI(record.time, record.duration, index);
            });
        } else {
            document.getElementById('wakeCount').value = 0;
            document.getElementById('wakeRecords').innerHTML = '';
        }
    }

    // æ›´æ–°ç¡çœ æŒ‡æ ‡æ˜¾ç¤º
    function updateSleepMetricsDisplay(data) {
        if (!data) return;
        
        const metrics = calculateSleepMetrics(data);
        
        // æ›´æ–°æ•ˆç‡
        document.getElementById('efficiencyNumber').textContent = metrics.efficiency;
        
        // æ›´æ–°å®é™…ä½œæ¯æ—¶é—´
        document.getElementById('actualSleepTime').textContent = `${data.lightsOffTime} - ${data.getUpTime}`;
        
        // æ›´æ–°ç¡çœ æ—¶é•¿
        document.getElementById('sleepDuration').textContent = metrics.sleepDuration;
        
        // æ›´æ–°å…¥ç¡é€Ÿåº¦
        document.getElementById('fallAsleepSpeed').textContent = `${data.timeToSleep}åˆ†é’Ÿ`;
        
        // æ›´æ–°åœ¨åºŠæ—¶é—´
        document.getElementById('effectiveSleep').textContent = metrics.timeInBed;
    }

    // è®¡ç®—ç¡çœ æŒ‡æ ‡
    function calculateSleepMetrics(data) {
        // è¿™é‡Œåº”è¯¥å®ç°è®¡ç®—ç¡çœ æ•ˆç‡ç­‰æŒ‡æ ‡çš„é€»è¾‘
        // ç¤ºä¾‹å®ç°
        return {
            efficiency: '85',  // ç¤ºä¾‹å€¼
            sleepDuration: '7h 30m',  // ç¤ºä¾‹å€¼
            timeInBed: '8h 15m'  // ç¤ºä¾‹å€¼
        };
    }

    // è®¡ç®—ç¡çœ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    function calculateSleepDuration(data) {
        // ç¤ºä¾‹å®ç°ï¼Œå®é™…åº”è¯¥æ ¹æ®dataä¸­çš„æ—¶é—´è®¡ç®—
        return 450;  // 7.5å°æ—¶ = 450åˆ†é’Ÿ
    }

    // æ·»åŠ é†’æ¥è®°å½•åˆ°UI
    function addWakeRecordToUI(time, duration, index) {
        const wakeRecordsContainer = document.getElementById('wakeRecords');
        const recordDiv = document.createElement('div');
        recordDiv.className = 'wake-record';
        recordDiv.innerHTML = `
            <div class="form-group">
                <label>é†’æ¥æ—¶é—´ #${index + 1}</label>
                <input type="time" class="wake-time" value="${time || ''}" required>
            </div>
            <div class="form-group">
                <label>æŒç»­æ—¶é—´(åˆ†é’Ÿ)</label>
                <input type="number" class="wake-duration" value="${duration || ''}" min="1" required>
            </div>
            <button type="button" class="remove-wake-record">åˆ é™¤</button>
        `;
        
        // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
        recordDiv.querySelector('.remove-wake-record').addEventListener('click', function() {
            wakeRecordsContainer.removeChild(recordDiv);
            updateWakeCount();
        });
        
        wakeRecordsContainer.appendChild(recordDiv);
    }

    // æ·»åŠ é†’æ¥è®°å½•
    function addWakeRecord() {
        const wakeCount = document.getElementById('wakeCount');
        const currentCount = parseInt(wakeCount.value) || 0;
        
        addWakeRecordToUI('', '', currentCount);
        
        // æ›´æ–°é†’æ¥æ¬¡æ•°
        wakeCount.value = currentCount + 1;
    }

    // æ›´æ–°é†’æ¥æ¬¡æ•°
    function updateWakeCount() {
        const records = document.querySelectorAll('.wake-record');
        document.getElementById('wakeCount').value = records.length;
    }

    function analyzeSleepPattern(data) {
        const analysis = {
            suggestions: [],
            patterns: []
        };

        // åˆ†æç¡çœ æ—¶é•¿
        const sleepDuration = calculateSleepDuration(data);
        if (sleepDuration < 420) { // 7å°æ—¶
            analysis.suggestions.push("ç¡çœ æ—¶é—´ä¸è¶³ï¼Œå»ºè®®ä¿è¯7-8å°æ—¶çš„ç¡çœ æ—¶é—´");
        }

        // åˆ†æå…¥ç¡æ—¶é—´
        if (data.timeToSleep > 30) {
            analysis.suggestions.push("å…¥ç¡æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®ï¼š\n- é¿å…ç¡å‰ä½¿ç”¨ç”µå­è®¾å¤‡\n- å°è¯•æ”¾æ¾æŠ€å·§å¦‚æ·±å‘¼å¸æˆ–å†¥æƒ³");
        }

        // åˆ†æç¡çœ æ•ˆç‡
        const metrics = calculateSleepMetrics(data);
        if (parseFloat(metrics.efficiency) < 85) {
            analysis.suggestions.push("ç¡çœ æ•ˆç‡åä½ï¼Œå»ºè®®ï¼š\n- å›ºå®šä½œæ¯æ—¶é—´\n- å‡å°‘åºŠä¸Šéç¡çœ æ´»åŠ¨");
        }

        return analysis;
    }

    function showHistory() {
        window.location.href = 'history.html';
    }

    function showAnalysis() {
        window.location.href = 'analysis.html';
    }
    
    // åœ¨sleepFormçš„submitäº‹ä»¶å¤„ç†ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç 
    document.getElementById('sleepForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // è·å–è¡¨å•æ•°æ®
        const formData = {
            date: document.getElementById('dateSelect').value,
            bedTime: document.getElementById('bedTime').value,
            lightsOffTime: document.getElementById('lightsOffTime').value,
            timeToSleep: parseInt(document.getElementById('timeToSleep').value),
            finalWakeTime: document.getElementById('finalWakeTime').value,
            getUpTime: document.getElementById('getUpTime').value,
            sleepQuality: parseInt(document.getElementById('sleepQuality').value),
            fatigueLevel: parseInt(document.getElementById('fatigueLevel').value),
            sleepAid: document.getElementById('sleepAid').value,
            hadDream: document.getElementById('hadDream').checked,
            dreamContent: document.getElementById('hadDream').checked ? document.getElementById('dreamContent').value : '',
            wakeRecords: []
        };
        
        // è·å–é†’æ¥è®°å½•
        const wakeRecords = document.querySelectorAll('.wake-record');
        wakeRecords.forEach(record => {
            formData.wakeRecords.push({
                time: record.querySelector('.wake-time').value,
                duration: parseInt(record.querySelector('.wake-duration').value)
            });
        });
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        const dateKey = `sleep_data_${formData.date}`;
        localStorage.setItem(dateKey, JSON.stringify(formData));
        
        // å‡†å¤‡åŒæ­¥åˆ°GitHubçš„å®Œæ•´æ•°æ®
        const allData = {};
        // è·å–æ‰€æœ‰sleep_data_å¼€å¤´çš„æœ¬åœ°å­˜å‚¨
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('sleep_data_')) {
                const date = key.replace('sleep_data_', '');
                allData[date] = JSON.parse(localStorage.getItem(key));
            }
        }
        
        // åŒæ­¥åˆ°GitHub
        if (typeof saveDataToGitHub === 'function') {
            saveDataToGitHub(allData)
                .then(success => {
                    if (success) {
                        alert('è®°å½•å·²ä¿å­˜å¹¶åŒæ­¥åˆ°GitHub');
                    } else {
                        alert('è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†åŒæ­¥åˆ°GitHubå¤±è´¥');
                    }
                    
                    // æ›´æ–°UIæ˜¾ç¤º
                    updateSleepMetricsDisplay(formData);
                    updateWeekView(new Date(formData.date));
                });
        } else {
            alert('è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°');
            // æ›´æ–°UIæ˜¾ç¤º
            updateSleepMetricsDisplay(formData);
            updateWeekView(new Date(formData.date));
        }
    });
    </script>