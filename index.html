<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>睡眠记录</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 顶部导航 -->
        <header>
            <h1>睡眠记录</h1>
            <div class="nav-buttons">
                <button onclick="window.location.href='history.html'" class="nav-btn">历史记录</button>
                <button onclick="window.location.href='analysis.html'" class="nav-btn">数据分析</button>
                <button id="githubLoginBtn" class="nav-btn">
                    <i class="fab fa-github"></i>
                    <span>连接GitHub</span>
                </button>
                <span id="syncStatus" class="sync-status"></span>
            </div>
        </header>

        <!-- 日历选择器 -->
        <div class="calendar-container">
            <div class="date-picker">
                <input type="date" id="dateSelect">
            </div>
            <div class="week-days">
                <!-- 日期会通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 睡眠效率展示 -->
        <div class="sleep-efficiency">
            <div class="circle">
                <span id="efficiencyNumber">--</span>%
                <div class="label">睡眠效率</div>
            </div>
        </div>

        <!-- 核心数据卡片 -->
        <div class="data-cards">
            <div class="data-card">
                <i class="icon">⏰</i>
                <div class="label">实际作息</div>
                <div class="value" id="actualSleepTime">--:-- - --:--</div>
            </div>
            <div class="data-card">
                <i class="icon">⌛</i>
                <div class="label">睡眠时间</div>
                <div class="value" id="sleepDuration">--h --m</div>
            </div>
            <div class="data-card">
                <i class="icon">🌙</i>
                <div class="label">入睡速度</div>
                <div class="value" id="fallAsleepSpeed">--分钟</div>
            </div>
            <div class="data-card">
                <i class="icon"><i class="fas fa-bed"></i></i>
                <div class="label">在床时间</div>
                <div class="value" id="effectiveSleep">--h --m</div>
            </div>
        </div>

        <!-- 记录表单 -->
        <form id="sleepForm">
            <div class="form-group">
                <label for="bedTime">
                    <i class="fas fa-bed"></i> 上床时间
                </label>
                <input type="time" id="bedTime" required>
            </div>

            <div class="form-group">
                <label for="lightsOffTime">
                    <i class="fas fa-lightbulb"></i> 关灯时间
                </label>
                <input type="time" id="lightsOffTime" required>
            </div>

            <div class="form-group">
                <label for="timeToSleep">
                    <i class="fas fa-moon"></i> 入睡时长
                </label>
                <input type="number" id="timeToSleep" required min="0">
            </div>

            <div class="form-group">
                <label for="wakeCount">
                    <i class="fas fa-clock"></i> 醒来次数
                </label>
                <input type="number" id="wakeCount" min="0" value="0">
            </div>

            <div id="wakeRecords">
                <!-- 动态添加醒来记录 -->
            </div>

            <button type="button" id="addWakeRecord" class="secondary-btn">添加醒来记录</button>

            <div class="form-group">
                <label for="finalWakeTime">
                    <i class="fas fa-sun"></i> 最终醒来时间
                </label>
                <input type="time" id="finalWakeTime" required>
            </div>

            <div class="form-group">
                <label for="getUpTime">
                    <i class="fas fa-walking"></i> 起床时间
                </label>
                <input type="time" id="getUpTime" required>
            </div>

            <!-- 评分滑块 -->
            <div class="ratings-container">
                <div class="form-group half-width">
                    <label for="sleepQuality">
                        <i class="fas fa-star"></i> 睡眠质量
                    </label>
                    <div class="slider-container">
                        <input type="range" id="sleepQuality" min="1" max="5" value="3">
                        <div class="slider-labels">
                            <span>很差</span>
                            <span>较差</span>
                            <span>一般</span>
                            <span>较好</span>
                            <span>很好</span>
                        </div>
                        <div class="quality-display">
                            <div id="sleepQualityIcon" class="quality-icon"></div>
                            <span id="sleepQualityValue">3分</span>
                        </div>
                    </div>
                </div>
                <div class="form-group half-width">
                    <label for="fatigueLevel">
                        <i class="fas fa-battery-three-quarters"></i> 睡醒后的精神状态
                    </label>
                    <div class="slider-container">
                        <input type="range" id="fatigueLevel" min="1" max="5" value="3">
                        <div class="slider-labels">
                            <span>非常疲惫</span>
                            <span>较为疲惫</span>
                            <span>一般</span>
                            <span>较为清醒</span>
                            <span>精神饱满</span>
                        </div>
                        <div class="quality-display">
                            <div id="fatigueLevelIcon" class="quality-icon"></div>
                            <span id="fatigueLevelValue">3分</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="sleepAid">
                    <i class="fas fa-pills"></i> 入睡辅助
                </label>
                <input type="text" id="sleepAid" placeholder="例如：冥想、阅读、音乐...">
            </div>

            <div class="dream-toggle">
                <label for="hadDream">
                    <i class="fas fa-cloud-moon"></i> 梦境记录
                    <input type="checkbox" id="hadDream">
                </label>
            </div>
            <div id="dreamContentContainer" style="display: none;">
                <div class="form-group">
                    <label for="dreamContent">
                        <i class="fas fa-edit"></i> 记录梦境内容
                    </label>
                    <textarea id="dreamContent" placeholder="描述你的梦..."></textarea>
                </div>
            </div>

            <button type="submit" class="submit-btn">保存记录</button>
        </form>

        <!-- 数据分析部分 -->
        <div class="analysis-section" style="display: none;">
            <div class="charts-container">
                <div class="chart-card">
                    <h3>睡眠趋势</h3>
                    <canvas id="sleepTrendChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>睡眠效率分析</h3>
                    <canvas id="sleepEfficiencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 历史记录部分 -->
        <div class="history-section" style="display: none;">
            <div class="history-filters">
                <select id="historyMonth"></select>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- 导出按钮 -->
        <div class="export-buttons">
            <button id="exportCSV" class="export-btn">导出CSV</button>
            <button id="exportJSON" class="export-btn">导出JSON</button>
        </div>

        <!-- 在页面底部添加设置面板 -->
        <div class="settings-panel" style="display: none;">
            <h3>设置</h3>
            <div class="settings-content">
                <div class="setting-item">
                    <button id="logoutBtn" class="secondary-btn">断开连接</button>
                </div>
            </div>
        </div>
    </div>

    <script src="github-sync.js"></script>
    <script src="script.js"></script>
    <script>
    document.getElementById('hadDream').addEventListener('change', function() {
        const container = document.getElementById('dreamContentContainer');
        container.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('dreamContent').value = '';
        }
    });

    // 确保页面加载时检查GitHub登录状态并加载数据
    document.addEventListener('DOMContentLoaded', function() {
        // 检查是否已登录GitHub
        const token = localStorage.getItem('github_token');
        if (token) {
            document.getElementById('githubLoginBtn').innerHTML = '<i class="fab fa-github"></i><span>已连接</span>';
            document.getElementById('syncStatus').textContent = '正在同步...';
            
            // 从GitHub加载数据
            loadDataFromGitHub(token)
                .then(() => {
                    document.getElementById('syncStatus').textContent = '同步成功';
                    // 加载当前日期的数据
                    loadCurrentDateData();
                })
                .catch(error => {
                    console.error('同步失败:', error);
                    document.getElementById('syncStatus').textContent = '同步失败';
                });
        }
        
        // 添加醒来记录按钮事件监听
        document.getElementById('addWakeRecord').addEventListener('click', addWakeRecord);
        
        // 设置日期选择器为今天
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        document.getElementById('dateSelect').value = dateString;
        
        // 初始化周视图
        updateWeekView(today);
        
        // 日期选择器变化事件
        document.getElementById('dateSelect').addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            updateWeekView(selectedDate);
            loadSelectedDateData(selectedDate);
        });
    });

    // 从GitHub加载数据的函数
    function loadDataFromGitHub(token) {
        return new Promise((resolve, reject) => {
            // 这里应该调用github-sync.js中的函数来获取数据
            // 假设github-sync.js中有一个fetchDataFromGitHub函数
            if (typeof fetchDataFromGitHub === 'function') {
                fetchDataFromGitHub(token)
                    .then(data => {
                        // 将数据保存到localStorage
                        if (data && typeof data === 'object') {
                            Object.keys(data).forEach(date => {
                                localStorage.setItem(`sleep_data_${date}`, JSON.stringify(data[date]));
                            });
                        }
                        resolve();
                    })
                    .catch(reject);
            } else {
                // 如果函数不存在，可能需要实现它
                console.warn('fetchDataFromGitHub函数未定义，请在github-sync.js中实现');
                reject(new Error('同步函数未实现'));
            }
        });
    }

    // 加载当前日期的数据
    function loadCurrentDateData() {
        const today = new Date();
        loadSelectedDateData(today);
    }

    // 加载选定日期的数据
    function loadSelectedDateData(date) {
        const dateString = date.toISOString().split('T')[0];
        const dataKey = `sleep_data_${dateString}`;
        const savedData = localStorage.getItem(dataKey);
        
        if (savedData) {
            const data = JSON.parse(savedData);
            // 填充表单和显示数据
            fillFormWithData(data);
            updateSleepMetricsDisplay(data);
        } else {
            // 清空表单
            document.getElementById('sleepForm').reset();
            // 重置显示
            document.getElementById('efficiencyNumber').textContent = '--';
            document.getElementById('actualSleepTime').textContent = '--:-- - --:--';
            document.getElementById('sleepDuration').textContent = '--h --m';
            document.getElementById('fallAsleepSpeed').textContent = '--分钟';
            document.getElementById('effectiveSleep').textContent = '--h --m';
        }
    }

    // 更新周视图
    function updateWeekView(centerDate) {
        const weekDaysContainer = document.querySelector('.week-days');
        weekDaysContainer.innerHTML = '';
        
        // 获取当前周的日期
        const currentDay = centerDate.getDay();
        const firstDay = new Date(centerDate);
        firstDay.setDate(centerDate.getDate() - currentDay);
        
        // 获取当前选中的日期字符串，用于比较
        const selectedDateString = document.getElementById('dateSelect').value;
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(firstDay);
            date.setDate(firstDay.getDate() + i);
            
            const dateString = date.toISOString().split('T')[0];
            const dayElement = document.createElement('div');
            dayElement.className = 'day-item';
            
            // 检查是否有数据
            const hasData = localStorage.getItem(`sleep_data_${dateString}`) !== null;
            
            // 检查是否是今天
            const isToday = date.toDateString() === new Date().toDateString();
            
            // 检查是否是选中日期 - 修改这里，直接比较日期字符串
            const isSelected = dateString === selectedDateString;
            
            if (isToday) dayElement.classList.add('today');
            if (isSelected) dayElement.classList.add('selected');
            if (hasData) dayElement.classList.add('has-data');
            
            dayElement.innerHTML = `
                <div class="day-name">${['日', '一', '二', '三', '四', '五', '六'][date.getDay()]}</div>
                <div class="day-number">${date.getDate()}</div>
            `;
            
            dayElement.addEventListener('click', function() {
                // 更新日期选择器的值
                document.getElementById('dateSelect').value = dateString;
                
                // 更新选中状态
                document.querySelectorAll('.day-item.selected').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
                
                // 加载选定日期的数据
                loadSelectedDateData(date);
            });
            
            weekDaysContainer.appendChild(dayElement);
        }
    }

    // 填充表单数据
    function fillFormWithData(data) {
        if (!data) return;
        
        // 填充基本字段
        if (data.bedTime) document.getElementById('bedTime').value = data.bedTime;
        if (data.lightsOffTime) document.getElementById('lightsOffTime').value = data.lightsOffTime;
        if (data.timeToSleep) document.getElementById('timeToSleep').value = data.timeToSleep;
        if (data.finalWakeTime) document.getElementById('finalWakeTime').value = data.finalWakeTime;
        if (data.getUpTime) document.getElementById('getUpTime').value = data.getUpTime;
        
        // 填充评分
        if (data.sleepQuality) {
            document.getElementById('sleepQuality').value = data.sleepQuality;
            document.getElementById('sleepQualityValue').textContent = `${data.sleepQuality}分`;
        }
        
        if (data.fatigueLevel) {
            document.getElementById('fatigueLevel').value = data.fatigueLevel;
            document.getElementById('fatigueLevelValue').textContent = `${data.fatigueLevel}分`;
        }
        
        // 填充其他字段
        if (data.sleepAid) document.getElementById('sleepAid').value = data.sleepAid;
        
        // 处理梦境记录
        if (data.hadDream) {
            document.getElementById('hadDream').checked = true;
            document.getElementById('dreamContentContainer').style.display = 'block';
            if (data.dreamContent) document.getElementById('dreamContent').value = data.dreamContent;
        } else {
            document.getElementById('hadDream').checked = false;
            document.getElementById('dreamContentContainer').style.display = 'none';
        }
        
        // 处理醒来记录
        if (data.wakeRecords && data.wakeRecords.length > 0) {
            document.getElementById('wakeCount').value = data.wakeRecords.length;
            
            // 清空现有记录
            document.getElementById('wakeRecords').innerHTML = '';
            
            // 添加每条醒来记录
            data.wakeRecords.forEach((record, index) => {
                addWakeRecordToUI(record.time, record.duration, index);
            });
        } else {
            document.getElementById('wakeCount').value = 0;
            document.getElementById('wakeRecords').innerHTML = '';
        }
    }

    // 更新睡眠指标显示
    function updateSleepMetricsDisplay(data) {
        if (!data) return;
        
        const metrics = calculateSleepMetrics(data);
        
        // 更新效率
        document.getElementById('efficiencyNumber').textContent = metrics.efficiency;
        
        // 更新实际作息时间
        document.getElementById('actualSleepTime').textContent = `${data.lightsOffTime} - ${data.getUpTime}`;
        
        // 更新睡眠时长
        document.getElementById('sleepDuration').textContent = metrics.sleepDuration;
        
        // 更新入睡速度
        document.getElementById('fallAsleepSpeed').textContent = `${data.timeToSleep}分钟`;
        
        // 更新在床时间
        document.getElementById('effectiveSleep').textContent = metrics.timeInBed;
    }

    // 计算睡眠指标
    function calculateSleepMetrics(data) {
        // 这里应该实现计算睡眠效率等指标的逻辑
        // 示例实现
        return {
            efficiency: '85',  // 示例值
            sleepDuration: '7h 30m',  // 示例值
            timeInBed: '8h 15m'  // 示例值
        };
    }

    // 计算睡眠时长（分钟）
    function calculateSleepDuration(data) {
        // 示例实现，实际应该根据data中的时间计算
        return 450;  // 7.5小时 = 450分钟
    }

    // 添加醒来记录到UI
    function addWakeRecordToUI(time, duration, index) {
        const wakeRecordsContainer = document.getElementById('wakeRecords');
        const recordDiv = document.createElement('div');
        recordDiv.className = 'wake-record';
        recordDiv.innerHTML = `
            <div class="form-group">
                <label>醒来时间 #${index + 1}</label>
                <input type="time" class="wake-time" value="${time || ''}" required>
            </div>
            <div class="form-group">
                <label>持续时间(分钟)</label>
                <input type="number" class="wake-duration" value="${duration || ''}" min="1" required>
            </div>
            <button type="button" class="remove-wake-record">删除</button>
        `;
        
        // 添加删除按钮事件
        recordDiv.querySelector('.remove-wake-record').addEventListener('click', function() {
            wakeRecordsContainer.removeChild(recordDiv);
            updateWakeCount();
        });
        
        wakeRecordsContainer.appendChild(recordDiv);
    }

    // 添加醒来记录
    function addWakeRecord() {
        const wakeCount = document.getElementById('wakeCount');
        const currentCount = parseInt(wakeCount.value) || 0;
        
        addWakeRecordToUI('', '', currentCount);
        
        // 更新醒来次数
        wakeCount.value = currentCount + 1;
    }

    // 更新醒来次数
    function updateWakeCount() {
        const records = document.querySelectorAll('.wake-record');
        document.getElementById('wakeCount').value = records.length;
    }

    function analyzeSleepPattern(data) {
        const analysis = {
            suggestions: [],
            patterns: []
        };

        // 分析睡眠时长
        const sleepDuration = calculateSleepDuration(data);
        if (sleepDuration < 420) { // 7小时
            analysis.suggestions.push("睡眠时间不足，建议保证7-8小时的睡眠时间");
        }

        // 分析入睡时间
        if (data.timeToSleep > 30) {
            analysis.suggestions.push("入睡时间较长，建议：\n- 避免睡前使用电子设备\n- 尝试放松技巧如深呼吸或冥想");
        }

        // 分析睡眠效率
        const metrics = calculateSleepMetrics(data);
        if (parseFloat(metrics.efficiency) < 85) {
            analysis.suggestions.push("睡眠效率偏低，建议：\n- 固定作息时间\n- 减少床上非睡眠活动");
        }

        return analysis;
    }

    function showHistory() {
        window.location.href = 'history.html';
    }

    function showAnalysis() {
        window.location.href = 'analysis.html';
    }
    
    // 在sleepForm的submit事件处理中添加以下代码
    document.getElementById('sleepForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 获取表单数据
        const formData = {
            date: document.getElementById('dateSelect').value,
            bedTime: document.getElementById('bedTime').value,
            lightsOffTime: document.getElementById('lightsOffTime').value,
            timeToSleep: parseInt(document.getElementById('timeToSleep').value),
            finalWakeTime: document.getElementById('finalWakeTime').value,
            getUpTime: document.getElementById('getUpTime').value,
            sleepQuality: parseInt(document.getElementById('sleepQuality').value),
            fatigueLevel: parseInt(document.getElementById('fatigueLevel').value),
            sleepAid: document.getElementById('sleepAid').value,
            hadDream: document.getElementById('hadDream').checked,
            dreamContent: document.getElementById('hadDream').checked ? document.getElementById('dreamContent').value : '',
            wakeRecords: []
        };
        
        // 获取醒来记录
        const wakeRecords = document.querySelectorAll('.wake-record');
        wakeRecords.forEach(record => {
            formData.wakeRecords.push({
                time: record.querySelector('.wake-time').value,
                duration: parseInt(record.querySelector('.wake-duration').value)
            });
        });
        
        // 保存到本地存储
        const dateKey = `sleep_data_${formData.date}`;
        localStorage.setItem(dateKey, JSON.stringify(formData));
        
        // 准备同步到GitHub的完整数据
        const allData = {};
        // 获取所有sleep_data_开头的本地存储
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('sleep_data_')) {
                const date = key.replace('sleep_data_', '');
                allData[date] = JSON.parse(localStorage.getItem(key));
            }
        }
        
        // 同步到GitHub
        if (typeof saveDataToGitHub === 'function') {
            saveDataToGitHub(allData)
                .then(success => {
                    if (success) {
                        alert('记录已保存并同步到GitHub');
                    } else {
                        alert('记录已保存到本地，但同步到GitHub失败');
                    }
                    
                    // 更新UI显示
                    updateSleepMetricsDisplay(formData);
                    updateWeekView(new Date(formData.date));
                });
        } else {
            alert('记录已保存到本地');
            // 更新UI显示
            updateSleepMetricsDisplay(formData);
            updateWeekView(new Date(formData.date));
        }
    });
    </script>